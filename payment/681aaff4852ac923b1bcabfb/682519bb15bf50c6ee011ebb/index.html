<html>

<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y2N3W6KSXL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-Y2N3W6KSXL');
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.utmify.com.br/scripts/utms/latest.js" data-utmify-prevent-xcod-sck data-utmify-prevent-subids async defer></script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" type="image/jpg" href="/assets/vtex.file-manager-graphql/images/30b948ee-9b10-4c2f-8758-fd82fb95361e___af80d9a5c64906e0662936151537ff10-26.svg">
  <title>Finalizar Pagamento</title>
  <link type="text/css" href="/css/delivry-25.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style type="text/css">
    h1, h2 { color: #ea1d2c; }
    header#topo .cover { background-color: #ea1d2c; }
    header#topo .info h1 { color: #ea1d2c; }
    header#topo .info .icones a { color: #ea1d2c; border-color: #ea1d2c; }
    header#topo .cover .logo {
      background-color: white !important;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    header#topo #menuCategorias { background: #ea1d2c; }
    footer { background: #ea1d2c; color: white; padding: 20px; text-align: center; }
    .btn, a.voltar { background: #ea1d2c; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; display: inline-block; margin-bottom: 20px; }
    
    .containerFinalizar { max-width: 800px; margin: 20px auto; padding: 20px; border: 2px solid #cecece; border-radius: 20px; background: white; }
    .payment { display: flex; flex-direction: column; align-items: center; gap: 20px; }
    #qrcode img { border-radius: 10px; max-width: 250px; }
    textarea { width: 100%; height: 80px; padding: 10px; border: 2px dashed #ea1d2c; border-radius: 10px; background: #fafafa; resize: none; font-size: 12px; }
    .copy-code { background-color: #ea1d2c; color: white; border: none; border-radius: 15px; padding: 12px; cursor: pointer; width: 100%; font-weight: bold; }
    
    .pix-security-alert { width: 100%; margin-top: 25px; }
    .alert-box { display: flex; gap: 12px; padding: 15px; background-color: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 8px; }
    .alert-icon { font-size: 24px; color: #2196f3; }
    .saiba-mais-toggle { display: flex; justify-content: space-between; padding: 12px; background: #f5f5f5; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    
    .how-to-pay { width: 100%; text-align: left; }
    .how-to-pay h3 { color: #ea1d2c; margin-bottom: 10px; }
    .how-to-pay p { margin: 5px 0; }
    
    .steps { display: flex; justify-content: space-between; width: 100%; margin-top: 30px; }
    .step { display: flex; flex-direction: column; align-items: center; gap: 5px; opacity: 0.4; }
    .step.current-step { opacity: 1; color: #ea1d2c; }
    .s-circle { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .step.current-step .s-circle { border-color: #ea1d2c; }
    .separator { flex: 1; height: 2px; background: #ccc; margin-top: 15px; }
    .separator.current-step { background: #ea1d2c; }
    .hidden { display: none !important; }
  </style>
</head>

<body>
  <header id="topo">
    <div class="cover main" style="background-position: center; background-size: cover; background-image: url('https://i.ibb.co/mVDwQN39/banner-237f7496.webp');">
      <div class="logo" style="background-color: white !important; display: flex; align-items: center; justify-content: center;">
        <img src="/SN8gVgwk/logocheff.png" style="width: 100%">
      </div>
      <div class="borda"></div>
    </div>
  </header>

  <div class="payment-area">
    <div class="container containerFinalizar">
      <h2 style="width: 100%; text-align: center" id="main-title">Falta pouco!</h2>
      <h3 style="width: 100%; text-align: center">Escaneie o QR CODE ou copie o código</h3>
      
      <a class="voltar" href="/shop/681aaff4852ac923b1bcabfb/checkout"><i class="fa fa-chevron-left"></i> VOLTAR</a>
      
      <div class="payment">
        <div id="timer-box" style="font-weight: bold; color: #ea1d2c;">Expira em: <span id="time-display">--:--</span></div>
        
        <div id="active-payment-area" style="width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px;">
          <div id="qrcode"></div>
          <textarea id="pix-text" readonly onclick="this.select()"></textarea>
          <button class="copy-code" id="copy-code">Copiar código PIX</button>
        </div>

        <div id="fallback-area" style="display: none; width: 100%; text-align: center; background: #fff4f4; padding: 20px; border-radius: 10px; border: 1px dashed #ea1d2c;">
          <h3 style="color: #ea1d2c;">O código expirou</h3>
          <button onclick="renovarPix()" style="background: #077c22; color: white; border: none; padding: 15px; border-radius: 50px; width: 100%; cursor: pointer; font-weight: bold;">GERAR NOVO PIX</button>
        </div>

        <div class="how-to-pay">
          <h3>Passo a passo:</h3>
          <p><b>1.</b> Abra o app do seu banco;</p>
          <p><b>2.</b> Escolha "Pix" e depois "QR Code" ou "Copia e Cola";</p>
          <p><b>3.</b> Finalize o pagamento e volte aqui.</p>
        </div>

        <div class="steps">
          <div class="step current-step"><div class="s-circle">1</div><span>Aguardando</span></div>
          <div class="separator current-step"></div>
          <div class="step"><div class="s-circle">2</div><span>Confirmado</span></div>
          <div class="separator"></div>
          <div class="step"><div class="s-circle">3</div><span>Entregue</span></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <b>Cheff Burguer</b><br>
    <small>CNPJ: 37.XXX.253/0001-51</small>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>
    let countdownInterval, checkInterval, currentPaymentData;

    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const dataParam = urlParams.get('data');
      if (!dataParam) return Swal.fire('Erro', 'Dados não encontrados.', 'error');

      try {
        currentPaymentData = JSON.parse(decodeURIComponent(dataParam));
        if(currentPaymentData.customer?.nome) {
          document.getElementById('main-title').textContent = `Falta pouco, ${currentPaymentData.customer.nome.split(" ")[0]}!`;
        }
        renderInterface(currentPaymentData);
      } catch (e) {
        Swal.fire('Erro', 'Falha ao processar dados.', 'error');
      }
    });

    function renderInterface(data) {
      document.getElementById('pix-text').value = data.pix_copy_paste;
      const qrEl = document.getElementById('qrcode');
      qrEl.innerHTML = '';
      if (data.qr_code_base64) {
        const img = document.createElement('img');
        img.src = data.qr_code_base64.startsWith('data:') ? data.qr_code_base64 : `data:image/png;base64,${data.qr_code_base64}`;
        img.style.width = '100%';
        qrEl.appendChild(img);
      } else {
        new QRCode(qrEl, { text: data.pix_copy_paste, width: 250, height: 250 });
      }
      startTimer(data.expiration_seconds || 1800);
      startPolling(data.transactionId);
    }

    function startTimer(duration) {
      let timer = duration;
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        let min = Math.floor(timer / 60), sec = timer % 60;
        document.getElementById('time-display').textContent = `${min < 10 ? '0' : ''}${min}:${sec < 10 ? '0' : ''}${sec}`;
        if (--timer < 0) handleExpiration();
      }, 1000);
    }

    function handleExpiration() {
      clearInterval(countdownInterval);
      clearInterval(checkInterval);
      document.getElementById('active-payment-area').style.display = 'none';
      document.getElementById('fallback-area').style.display = 'block';
    }

    function startPolling(id) {
      if(!id) return;
      clearInterval(checkInterval);
      checkInterval = setInterval(async () => {
        try {
          const res = await fetch(`/api/check-status?id=${id}`);
          const status = await res.json();
          if (status.paid) {
            clearInterval(checkInterval);
            Swal.fire('Sucesso', 'Pagamento aprovado!', 'success').then(() => window.location.href = '/entrega');
          }
        } catch (e) {}
      }, 5000);
    }

    document.getElementById('copy-code').addEventListener('click', () => {
      const text = document.getElementById('pix-text');
      text.select();
      document.execCommand('copy');
      const btn = document.getElementById('copy-code');
      btn.textContent = "COPIADO!";
      btn.style.background = "#077c22";
      setTimeout(() => { btn.textContent = "Copiar código PIX"; btn.style.background = "#ea1d2c"; }, 2000);
    });

    async function renovarPix() {
      try {
        const res = await fetch('/api/generate-pix', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            customer: currentPaymentData.customer,
            total: currentPaymentData.amount || currentPaymentData.total,
            items: currentPaymentData.items
          })
        });
        const data = await res.json();
        if(data.success) {
          currentPaymentData = data;
          document.getElementById('fallback-area').style.display = 'none';
          document.getElementById('active-payment-area').style.display = 'flex';
          renderInterface(data);
        }
      } catch(e) { Swal.fire('Erro', 'Falha ao renovar.', 'error'); }
    }
  </script>
</body>
</html>